# FenHouse — Clojure + Fenster (JNI) + GraalVM

A tiny 2D raster demo that draws a “house” (lines, rectangles, circle, flood-fill, bitmap text) in a native macOS window — written in **Clojure**, talking to the Fenster C library via a JNI shim, and compiled to a native binary with GraalVM Native Image. The build also produces a self-contained macOS `.app` bundle.

Why JNI (not Panama/FFM)? On Apple Silicon, the GraalVM Native Image toolchain you’re likely using does not support the Foreign Function & Memory (FFM) API in native images for arm64 in a way that works here. JNI is stable on arm64 and works today.

---

## Features

- Pure Clojure raster routines mirroring the original C sample:
  - Bresenham line, rectangle fill, midpoint circle, naive flood-fill
  - tiny 5×3 bitmap font renderer
- Minimal JNI shim wrapping `fenster.h`
- Native macOS window via Cocoa (Fenster uses `Cocoa` + `AudioToolbox`)
- Native Image build that embeds the JNI dylib inside the binary as a resource

---

## Requirements

- macOS 12+ on Apple Silicon (arm64)
- Xcode Command Line Tools: `cc`, `sips`, `iconutil`, `zip`
- GraalVM JDK 24 with `native-image` installed
- Clojure CLI (`clj` / `clojure`)
- `curl`

---

## Tools & dependencies

Languages / SDKs
- Clojure 1.12.2
- GraalVM 24
- Clang/LLVM (via Xcode tools)

Build tooling
- `clojure.tools.build` 0.10.5
- GraalVM native-image
- `make`

Runtime glue
- JNI (`JNI_OnLoad`, exported `Java_…` symbols)
- macOS frameworks: Cocoa, AudioToolbox

Third-party
- Fenster by @zserge — single-header windowing lib (`fenster.h`)
  https://github.com/zserge/fenster
- clj-easy/graal-build-time 1.0.5 — keeps essential Clojure namespaces initialized/retained inside native images
  https://github.com/clj-easy/graal-build-time

---

## Project layout

```
.
├─ src/
│  └─ demo/
│     ├─ fenhouse.clj        ; app (AOT entrypoint)
│     └─ FenShim.java        ; Java JNI bridge (loads dylib, native methods)
├─ native/
│  ├─ fen_shim_jni.c         ; JNI shim (#includes fenster.h and demo_FenShim.h)
│  ├─ fenster.h              ; downloaded during build
│  └─ demo_FenShim.h         ; generated by `javac -h` (do not edit)
├─ resources/
│  └─ native/
│     └─ libfen_shim_jni.dylib  ; copied here and embedded in the image
├─ build.clj                 ; tools.build (javac first, then AOT Clojure)
├─ deps.edn                  ; deps + paths (includes "resources")
└─ Makefile                  ; incremental build + .app bundling
```

---

## Quick start (Makefile)

```bash
make help
```

---

## Configuration notes

- Entry point / AOT: `src/demo/fenhouse.clj` should have:

  ```clojure
  (ns demo.fenhouse
    (:gen-class :main true)
    ;; imports …
  )
  ```

- First line in `-main — force the Java loader to run at runtime:

  ```clojure
  (defn -main [& _]
    (Class/forName "demo.FenShim") ;; triggers static loader → System.load(...)
    ;; … your draw loop …
  )
  ```

- `FenShim.java` loader: tries `System.loadLibrary("fen_shim_jni")`, then falls back to extracting the bundled resource `resources/native/libfen_shim_jni.dylib` to a temp file and `System.load`-ing it.

- `deps.edn` should include:
  - `:paths ["src" "resources"]`
  - `org.clojure/clojure {:mvn/version "1.12.2"}`
  - `com.github.clj-easy/graal-build-time {:mvn/version "1.0.5"}`
  - a `:run` alias with `:jvm-opts ["-XstartOnFirstThread" "-Djava.library.path=./native"]` (the resource fallback makes the library path optional)

---
